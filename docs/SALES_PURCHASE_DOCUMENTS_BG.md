# Документи за продажба и покупка

## Преглед

Системата за управление на документи за продажба и покупка предоставя пълна функционалност за създаване, управление и проследяване на търговски документи в съответствие с българското законодателство и най-добрите счетоводни практики.

## Основни компоненти

### 1. Фактури (Invoices)

Фактурите са основен документ за продажба на стоки и услуги с пълна ДДС съвместимост.

#### Основни характеристики:
- Автоматично номериране с 10-цифрен формат (ИН0000000001)
- Поддръжка на всички 95 типа ДДС документи по НР
- Мултивалутни операции с автоматично преобразуване
- Статус workflow: чернова → издадена → частично платена → платена
- Интеграция с ДДС регистри

#### Типове ДДС документи:
- **01** - Фактура
- **02** - Дебитно известие
- **03** - Кредитно известие
- **04** - Проформа фактура
- **05** - Фактура за авансово плащане
- **10** - Документ за вътреобщностна доставка
- **11** - Документ за вътреобщностно придобиване
- **12** - Документ за износ
- **96** - ДДС протокол

### 2. Поръчки за доставка (Purchase Orders)

Поръчките за доставка управляват процеса на закупуване на стоки и услуги от доставчици.

#### Workflow процес:
1. **Чернова** (Draft) - Създаване и редактиране
2. **Изпратена** (Sent) - Изпращане към доставчик
3. **Потвърдена** (Confirmed) - Потвърждение от доставчик
4. **Частично получена** (Partially Received) - Частично получаване
5. **Получена** (Received) - Пълно получаване
6. **Закрита** (Closed) - Финализиране

#### Основни полета:
- Номер на поръчката (ПО0000000001)
- Доставчик и склад на получаване
- Очаквана дата на доставка
- Редове с продукти, количества и цени
- Статус на получаване по редове

### 3. Оферти (Quotations)

Офертите управляват процеса на предлагане на стоки и услуги на клиенти.

#### Workflow процес:
1. **Чернова** (Draft) - Подготовка на оферта
2. **Изпратена** (Sent) - Изпращане към клиент
3. **Отворена** (Open) - Оферта в сила
4. **Приета** (Accepted) - Приемане от клиента
5. **Отхвърлена** (Rejected) - Отхвърляне от клиента
6. **Изтекла** (Expired) - Изтичане на валидност
7. **Конвертирана във фактура** (Converted to Invoice)

#### Допълнителни функционалности:
- Валидност на офертата
- Вероятност за печалба (%)
- Опционални редове
- Алтернативни продукти
- Проследяване на последващи действия

## Система за номериране

### Автоматично номериране

Всеки тип документ получава уникален 10-цифрен номер с водещи нули:

```
ИН0000000001 - Фактура №1
ПО0000000001 - Поръчка за доставка №1
ОФ0000000001 - Оферта №1
КН0000000001 - Кредитно известие №1
```

### UID система

Всеки документ получава уникален идентификатор (UID) с формат:
```
{тип}-{организация_short}-{номер}-{timestamp}
```

Пример:
```
invoice-a1b2c3d4-ИН0000000001-20250114103045
```

### Предимства на UID системата:
- Гарантирана уникалност
- Лесно търсене и филтриране
- Поддръжка на мулти-тенант среда
- Защита от race conditions

## ДДС съвместимост

### Български ДДС документи

Системата поддържа всички 95 типа ДДС документи, изисквани от Националната агенция за приходите (НР):

#### Основни типове:
- **Фактури за продажба** (01-06)
- **Митнически документи** (07)
- **Банкови документи** (08)
- **Фискални бележки** (09)
- **Вътреобщностни операции** (10-11)
- **Износ/внос** (12-13)
- **Услуги в чужбина** (14-15)
- **Освободени доставки** (16-95)
- **ДДС протоколи** (96)

### ДДС освободени доставки:

Поддържат се всички причини за освобождаване от ДДС:
- Вътреобщностна доставка
- Извънобщностен износ
- Услуги в чужбина
- Инвестиционни доставки
- Финансови услуги
- Образователни услуги
- Здравни услуги
- Застрахователни услуги
- И др.

### OSS (One-Stop Shop)

Поддръжка на OSS за доставки към клиенти от ЕС:
- Автоматично изчисляване на ДДС по държава
- Отделяне на OSS ДДС
- Генериране на OSS справки

## Workflow управление

### Статус преходи

Всеки тип документ има дефиниран workflow с контролирани преходи:

#### Фактура:
```
Чернова → Издадена → Частично платена → Платена
    ↓           ↓              ↓
 Отменена   Просрочена    Отменена
```

#### Поръчка за доставка:
```
Чернова → Изпратена → Потвърдена → Частично получена → Получена → Закрита
    ↓         ↓           ↓              ↓                ↓
 Отменена  Отменена   Отменена      Отменена
```

#### Оферта:
```
Чернова → Изпратена → Отворена → Приета → Конвертирана
    ↓         ↓          ↓         ↓
 Отменена  Изтекла   Отхвърлена
```

### Права и разрешения

Всеки преход изисква специфично право:
- `invoice.issue` - Издаване на фактура
- `purchase_order.send` - Изпращане на поръчка
- `quotation.accept` - Приемане на оферта
- `payment.create` - Създаване на плащане

### Валидация

Автоматична валидация на:
- Бизнес правила
- ДДС съвместимост
- Статус преходи
- Потребителски права

## API ендпойнти

### Фактури
```
GET    /api/invoices              - Списък с фактури
GET    /api/invoices/{id}         - Детайли за фактура
POST   /api/invoices              - Нова фактура
PUT    /api/invoices/{id}         - Редакция на фактура
DELETE /api/invoices/{id}         - Изтриване на фактура
POST   /api/invoices/{id}/issue   - Издаване на фактура
POST   /api/invoices/{id}/cancel  - Анулиране на фактура
```

### Поръчки за доставка
```
GET    /api/purchase-orders              - Списък с поръчки
GET    /api/purchase-orders/{id}         - Детайли за поръчка
POST   /api/purchase-orders              - Нова поръчка
PUT    /api/purchase-orders/{id}         - Редакция на поръчка
DELETE /api/purchase-orders/{id}         - Изтриване на поръчка
POST   /api/purchase-orders/{id}/send    - Изпращане на поръчка
POST   /api/purchase-orders/{id}/confirm - Потвърждаване на поръчка
```

### Оферти
```
GET    /api/quotations              - Списък с оферти
GET    /api/quotations/{id}         - Детайли за оферта
POST   /api/quotations              - Нова оферта
PUT    /api/quotations/{id}         - Редакция на оферта
DELETE /api/quotations/{id}         - Изтриване на оферта
POST   /api/quotations/{id}/send    - Изпращане на оферта
POST   /api/quotations/{id}/accept  - Приемане на оферта
POST   /api/quotations/{id}/reject  - Отхвърляне на оферта
POST   /api/quotations/{id}/convert-to-invoice - Конвертиране във фактура
```

## Интеграции

### Складова интеграция

- **Поръчки за доставка** → Автоматично създаване на складови движения при получаване
- **Фактури** → Резервиране на стоки при издаване
- **Оферти** → Проверка на наличности при създаване

### Счетоводна интеграция

- Автоматично генериране на счетоводни записи
- Интеграция с ДДС регистри
- Проследяване на вземания и задължения

### Валутна интеграция

- Автоматично преобразуване на валути
- Поддръжка на курсове към основна валута
- История на валутните курсове

## Справки и анализи

### Стандартни справки:
- Списък с фактури по период
- Неплатени фактури
- Просрочени фактури
- Поръчки за доставка по статус
- Оферти по вероятност за печалба
- ДДС справки по период

### Аналитични справки:
- Обороти по клиенти
- Обороти по продукти
- Маржиналност по поръчки
- Ефективност на оферти
- Срокове на плащане

## Сигурност

### Контрол на достъпа:
- Ролева базирана сигурност
- Права по типове документи
- Организационна изолация
- Audit trail на всички операции

### Защита на данните:
- Шифриране на чувствителни данни
- Backup и recovery
- GDPR съвместимост

## Мулти-тенант поддръжка

Системата поддържа множество организации:
- Пълна изолация на данните
- Отделни номерации по организации
- Конфигурируеми настройки
- Централизирано управление

## Мобилна поддръжка

API е оптимизиран за мобилни приложения:
- RESTful дизайн
- JSON формати
- Pagination
- Offline поддръжка
- Push нотификации

## Бъдещи развития

## Нови функционалности

### 1. Разширена поддръжка на ДДС документи

#### Пълна НАП съвместимост
Системата имплементира всички 95 типа ДДС документи, изисквани от НАП чрез `VatDocumentType` enum:

**Търговски документи (01-06):**
- Фактури, дебитни/кредитни известия
- Проформа фактури и авансови плащания
- Фактури за окончателно разплащане

**Митнически и банкови документи (07-09):**
- Митнически документи за внос/износ
- Банкови документи и валутни операции
- Фискални бележки от ПОС терминали

**Вътреобщностни операции (10-11):**
- Документи за доставки към ЕС клиенти
- Документи за придобивания от ЕС доставчици

**Международни операции (12-15):**
- Извънобщностен износ и внос
- Услуги към/от клиенти извън ЕС

**Освободени доставки (16-95):**
- Пълна поддръжка чрез `VatExemptionReason` enum
- Покритие на всички освободени сектори

#### Автоматично ДДС изчисляване
- **Real-time валидация** - Проверка на ДДС номера на контрагент
- **Автоматични ставки** - Избор на правилна ДДС ставка
- **OSS интеграция** - Автоматично облагане за ЕС доставки
- **Освобождаване** - Автоматично освождаване при условия

### 2. Модерен уеб интерфейс

#### React TypeScript компоненти
- **Form validation** - Real-time валидация на всички полета
- **Auto-calculation** - Автоматично изчисляване на суми и ДДС
- **Type safety** - Пълна TypeScript поддръжка
- **Responsive design** - Мобилно съобразен интерфейс

#### Workflow управление
- **Draft → Issue → Payment** - Контролиран процес
- **Status tracking** - Реално проследяване на статуси
- **Notifications** - Автоматични известия
- **Audit trail** - Пълен лог на всички действия

### 3. Мултивалутни операции

#### Пълна валутна поддръжка
- **Multi-currency** - Фактури във всяка валута
- **Auto-conversion** - Автоматично преобразуване
- **Exchange rates** - Поддръжка на валутни курсове
- **Historical data** - История на курсовете

#### Функционалности:
- **Real-time rates** - Актуални валутни курсове
- **Manual override** - Ръчно задаване на курсове
- **Currency validation** - Валидация на ISO 4217 кодове
- **Multi-lingual** - Поддръжка на различни езици

### 4. Интелигентни функции

#### AI базирани възможности
- **Document recognition** - Автоматично разпознаване
- **Data extraction** - Извличане на данни от документи
- **Fraud detection** - Откриване на подозрителни операции
- **Predictive analytics** - Прогнозиране на плащания

#### Business Intelligence
- **Sales forecasting** - Прогнозиране на продажби
- **Customer analytics** - Анализ на клиентско поведение
- **Performance metrics** - KPI проследяване
- **Custom reports** - Персонализирани справки

## Планирани функционалности:
- Електронно подписване на документи
- Интеграция с банкови системи
- AI базирано прогнозиране
- Разширена аналитика
- Междувалутни операции

## Технологични подобрения:
- Real-time синхронизация
- GraphQL API
- Microservices архитектура
- Cloud deployment
- Advanced caching